# 통신사 상담 매뉴얼 검색 알고리즘

## 개요

고객센터 상담원이 고객의 구어체 질문을 입력하면, 관련 매뉴얼 페이지를 자동으로 찾아주는 **하이브리드 검색 시스템**입니다.

벡터 시맨틱 검색(의미 기반)과 키워드 텍스트 매칭(단어 기반)을 결합하여, 자연어 문장과 짧은 키워드 모두에서 정확한 결과를 반환합니다.

---

## 전체 아키텍처

```
┌─────────────────────────────────────────────────────┐
│                    업로드 파이프라인                      │
│                                                       │
│  PDF ─→ 페이지별 텍스트 추출                              │
│          ├─→ GPT-4o-mini: 고객 질문 10개 생성             │
│          ├─→ 텍스트 + 질문 합산 → OpenAI 임베딩 생성        │
│          ├─→ Puppeteer: 페이지 PNG 이미지 렌더링           │
│          └─→ DB 저장 (텍스트, 임베딩, 이미지 URL)           │
└─────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────┐
│                    검색 파이프라인                       │
│                                                       │
│  고객 질문 ──┬──→ OpenAI 임베딩 생성 ──┐                  │
│  (구어체)    │                        ├──→ 하이브리드 검색  │
│             └──→ GPT 키워드 추출 ─────┘       │          │
│                                              ▼          │
│                                    벡터 유사도 + 키워드 매칭  │
│                                    점수 합산 → 상위 5건 반환  │
└─────────────────────────────────────────────────────┘
```

---

## 1단계: 업로드 시 인덱싱

PDF가 업로드되면 각 페이지에 대해 다음 처리를 수행합니다.

### 1-1. 텍스트 추출

- `pdfjs-dist`로 페이지별 텍스트 추출
- 50자 미만 페이지는 스킵 (표지, 빈 페이지 등)

### 1-2. 고객 질문 생성 (GPT-4o-mini)

매뉴얼 텍스트만으로는 고객의 구어체 표현과 벡터 유사도가 낮을 수 있습니다.
이를 보완하기 위해, GPT에게 해당 페이지와 관련된 **고객 질문 예시 10개**를 생성시킵니다.

```
매뉴얼: "6.1 자동 로밍 안내 - 해외에서 통신사 가입 단말로 통신 서비스 이용..."
   ↓ GPT-4o-mini
생성 질문:
  - "해외에서 폰이 되나요?"
  - "유럽 여행 가는데 로밍 어떻게 해요?"
  - "외국에서 데이터 쓸 수 있어요?"
  ...
```

### 1-3. 임베딩 생성 (OpenAI text-embedding-3-small)

페이지 원문과 생성된 질문을 합쳐서 하나의 임베딩 벡터(1536차원)를 생성합니다.

```
임베딩 입력 =
  [페이지 내용]
  6.1 자동 로밍 안내 로밍 개요 ...
  [고객 질문 예시]
  - 해외에서 폰이 되나요?
  - 유럽 여행 가는데 로밍 어떻게 해요?
  ...
```

이렇게 하면 매뉴얼의 공식 용어와 고객의 구어체 표현이 하나의 벡터 공간에 함께 인코딩되어, 자연어 검색 정확도가 올라갑니다.

### 1-4. 페이지 이미지 렌더링

- Puppeteer + pdf.js로 각 페이지를 PNG 이미지로 렌더링
- Supabase Storage에 저장
- 검색 결과 클릭 시 원본 PDF 페이지 이미지로 표시

---

## 2단계: 검색 시 하이브리드 매칭

사용자가 검색어를 입력하면 두 가지 경로가 **병렬로** 실행됩니다.

### 2-1. 벡터 시맨틱 검색 (의미 기반)

```
"여행갈때 폰 쓰고싶어요"
   ↓ OpenAI text-embedding-3-small
   ↓ 1536차원 벡터
   ↓ pgvector 코사인 유사도 (1 - cosine distance)
   ↓ 업로드 시 저장된 임베딩과 비교
```

- 의미적으로 유사한 페이지를 찾음
- "여행갈때 폰" ↔ "해외에서 통신 서비스 이용" 매칭 가능
- threshold: 0.2 이상

### 2-2. GPT 키워드 추출 + 텍스트 매칭 (단어 기반)

```
"여행갈때 폰 쓰고싶어요"
   ↓ GPT-4o-mini 키워드 추출
   ↓ ["로밍", "해외", "여행"]
   ↓ 각 키워드로 content ILIKE 매칭 (공백 무시)
```

- GPT가 구어체를 공식 용어로 변환: "여행" → "로밍", "해외"
- PDF 텍스트의 공백 문제 해결: `replace(content, ' ', '')`로 비교
  - `"로밍 서비 스"` → `"로밍서비스"` → "로밍" 매칭 성공

### 2-3. 점수 합산

```sql
최종 점수 = 벡터 유사도 + (매칭된 키워드 개수 × 0.15)
```

| 페이지 | 벡터 유사도 | 매칭 키워드 | 키워드 보너스 | 최종 점수 |
|--------|-----------|-----------|------------|----------|
| 로밍 안내 (p.34) | 0.35 | 로밍, 해외 (2개) | +0.30 | **0.65** |
| 로밍 요금제 (p.35) | 0.32 | 로밍 (1개) | +0.15 | **0.47** |
| 보험 서비스 (p.24) | 0.28 | 없음 | +0.00 | **0.28** |

키워드가 많이 매칭될수록 높은 점수를 받아 상위에 노출됩니다.

### 2-4. 결과 선정 기준

다음 중 하나라도 만족하면 후보에 포함:
1. 벡터 유사도 > 0.2 (시맨틱 매칭)
2. 키워드 1개 이상 ILIKE 매칭 (텍스트 매칭)

최종 점수 내림차순으로 정렬 후 상위 5건 반환.

---

## 검색 시나리오 예시

| 고객 발화 | 추출 키워드 | 기대 결과 |
|----------|-----------|----------|
| "유럽가요" | 로밍, 해외, 유럽, 국제 | 로밍 서비스 (p.34~37) |
| "데이터가 모자라요" | 데이터, 리필, 소진, 쿠폰 | 데이터 리필/쿠폰 (p.22~23) |
| "폰을 바꿨는데요" | 기기변경, 개통, 단말 | 기기변경 절차 (p.29) |
| "요금 너무 많이 나왔어" | 요금, 청구, 과금, 이의 | 요금 청구/이의 (p.16~20) |
| "폰 잃어버렸어요" | 분실, 도난, 정지, 보험 | 분실/습득 신고 (p.33) |
| "번호 옮기고 싶어요" | 번호이동, MNP, 전입 | 번호이동 처리 (p.30) |
| "해지하고 싶어요" | 해지, 위약금, 해약 | 해지 절차 (p.40~41) |
| "인터넷이 느려요" | 속도, 저하, 데이터, 네트워크 | 속도저하 대응 (p.45) |
| "여행갈때 폰 쓰고싶어요" | 로밍, 해외, 여행 | 로밍 서비스 (p.34~37) |
| "멤버십 등급 어떻게 되나요" | 멤버십, 등급, VIP, 혜택 | 멤버십/혜택 (p.26) |

---

## 기술 스택

| 구성요소 | 기술 | 역할 |
|---------|------|------|
| 벡터 DB | Supabase (pgvector) | 임베딩 저장 및 코사인 유사도 검색 |
| 임베딩 모델 | OpenAI text-embedding-3-small | 텍스트 → 1536차원 벡터 변환 |
| 키워드 추출 | GPT-4o-mini | 구어체 → 공식 용어 키워드 변환 |
| 질문 생성 | GPT-4o-mini | 매뉴얼 페이지별 고객 질문 예시 생성 |
| PDF 렌더링 | Puppeteer + pdf.js | 페이지별 PNG 이미지 생성 |
| 프론트엔드 | Next.js + TypeScript | 검색 UI 및 결과 표시 |
| 스토리지 | Supabase Storage | 페이지 이미지 저장 |

---

## 왜 하이브리드인가?

| 방식 | 장점 | 한계 |
|------|------|------|
| 벡터만 | 의미 기반 매칭 ("여행" ↔ "로밍") | 짧은 키워드에 약함 ("로밍" 단독 검색) |
| 키워드만 | 정확한 단어 매칭 | 동의어/유의어 처리 불가 |
| **하이브리드** | **양쪽 장점 결합** | - |

하이브리드 검색은 두 방식의 약점을 서로 보완합니다:
- **자연어 문장** → 벡터 유사도가 처리
- **짧은 키워드** → GPT 키워드 확장 + ILIKE 매칭이 처리
- **구어체 ↔ 전문용어 간극** → GPT가 변환하여 연결

---

## 데이터 흐름 요약

```
[업로드]
PDF → 텍스트 추출 → GPT 질문 생성 → 임베딩(텍스트+질문) → DB 저장
                                                          + 이미지 → Storage

[검색]
고객 질문 ──→ 임베딩 ──────────┐
          ──→ GPT 키워드 추출 ──┤
                               ▼
                    DB: 벡터 유사도 + 키워드 ILIKE
                               ▼
                    점수 합산 → 상위 5건 → UI 표시 (이미지 or 텍스트)
```
