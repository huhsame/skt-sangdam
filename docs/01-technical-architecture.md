# AI 실시간 상담 어시스턴트 — 기술 아키텍처

## 시스템 개요

고객 음성을 실시간으로 인식하고, AI가 자연어를 분석하여 관련 매뉴얼과 CRM 업무 화면을 자동으로 표시하는 상담원 지원 시스템.

```
고객 음성 → 실시간 STT → GPT 키워드 추출 → 시맨틱 검색 + CRM 화면 자동 전환
```

상담원은 **클릭 0회**로 필요한 정보를 모두 받는다.

---

## 전체 아키텍처

```
┌─ 클라이언트 (브라우저) ────────────────────────────────────────────────────┐
│                                                                           │
│  마이크 (48kHz) → AudioWorklet (리샘플링 24kHz PCM16) → base64 인코딩     │
│       │                                                                   │
│       ▼                                                                   │
│  WebSocket ──────────────────────► OpenAI Realtime API                    │
│       │                            (gpt-4o-mini-transcribe)               │
│       │                            Server VAD (500ms silence)             │
│       │                            근거리 노이즈 제거                      │
│       │                                    │                              │
│       ◄────────────── 실시간 텍스트 스트리밍 ─┘                            │
│       │                                                                   │
│       ▼ 발화 완료 시                                                      │
│  ┌─────────────────────────────────────────────────────────┐              │
│  │  POST /api/search                                       │              │
│  │  ┌─────────────────────┐  ┌──────────────────────────┐  │              │
│  │  │ getEmbedding()      │  │ extractKeywords()        │  │              │
│  │  │ text-embedding-     │  │ GPT-4o-mini              │  │              │
│  │  │ 3-small (1536d)     │  │ 구어체 → 업무용어 변환   │  │              │
│  │  └────────┬────────────┘  └────────────┬─────────────┘  │              │
│  │           │       병렬 실행             │                │              │
│  │           ▼                             │                │              │
│  │  Supabase pgvector                      │                │              │
│  │  match_pages() RPC                      │                │              │
│  │  코사인 유사도 검색                     │                │              │
│  │           │                             │                │              │
│  │           ▼                             ▼                │              │
│  │  응답: { results: [...], keywords: ["로밍","해외"] }     │              │
│  └─────────────────────────────────────────────────────────┘              │
│       │                                │                                  │
│       ▼                                ▼                                  │
│  ContentViewer                  determineCrmScreen()                      │
│  (매뉴얼 PDF 표시)              키워드 → CRM 화면 타입 매핑               │
│                                        │                                  │
│                                        ▼                                  │
│                                 CrmDemoPanel                              │
│                                 (CRM 업무 화면 표시)                      │
└───────────────────────────────────────────────────────────────────────────┘
```

---

## 핵심 기술 컴포넌트

### 1. 실시간 음성 인식 파이프라인

| 단계 | 기술 | 역할 |
|---|---|---|
| 음성 캡처 | Web Audio API + getUserMedia | 48kHz 모노, 에코/노이즈 제거 |
| 오디오 처리 | AudioWorklet | 48kHz → 24kHz PCM16 리샘플링 |
| 전송 | WebSocket | base64 인코딩된 PCM 스트리밍 |
| 음성 인식 | OpenAI Realtime API | gpt-4o-mini-transcribe, 한국어 |
| 발화 감지 | Server-side VAD | 500ms 무음 감지로 자동 분리 |
| 노이즈 제거 | near_field 모드 | 콜센터 환경 최적화 |

**동작 흐름:**
1. 마이크 오디오를 AudioWorklet에서 24kHz PCM16으로 리샘플링
2. WebSocket으로 OpenAI Realtime API에 실시간 스트리밍
3. 서버 측 VAD가 발화 시작/종료를 자동 감지
4. `delta` 이벤트로 실시간 부분 텍스트 표시 (타이핑 효과)
5. `completed` 이벤트 시 전체 발화 텍스트로 즉시 검색 트리거

### 2. AI 키워드 추출 (자연어 → 업무용어 변환)

```
입력: "유럽 가는데 폰 되나요?"
     ↓ GPT-4o-mini
출력: ["로밍", "해외", "유럽", "국제"]
```

- **모델**: GPT-4o-mini (낮은 레이턴시, 저비용)
- **시스템 프롬프트**: 통신사 도메인 특화 (요금제, 로밍, 분실, 해지 등 18개 카테고리)
- **구어체 매핑**: "폰 잃어버렸어요" → `["분실", "도난", "정지", "보험"]`
- **최대 6개 키워드** 추출, 실패 시 원본 쿼리로 폴백

### 3. 시맨틱 검색 (Vector Similarity Search)

```sql
-- Supabase pgvector 기반
SELECT *, 1 - (embedding <=> query_embedding) AS similarity
FROM document_pages
WHERE similarity > 0.2
ORDER BY embedding <=> query_embedding
LIMIT 5;
```

| 항목 | 상세 |
|---|---|
| 임베딩 모델 | OpenAI text-embedding-3-small (1536차원) |
| 벡터 DB | Supabase PostgreSQL + pgvector |
| 인덱스 | IVFFlat (코사인 거리, lists=10) |
| 유사도 임계값 | 0.2 (폭넓은 매칭) |
| 반환 | 상위 5개 결과 (유사도 내림차순) |

**키워드 추출과 임베딩 생성은 병렬 실행**하여 응답 시간을 최소화.

### 4. CRM 화면 자동 매핑

GPT가 추출한 키워드를 6개 업무 화면 타입에 매핑:

```
"로밍","해외","국제","유럽","여행"      → 로밍 설정 화면
"분실","도난","정지","잠금","보험"      → 분실/도난 신고 화면
"해지","위약금","해약","탈퇴"          → 해지 처리 화면
"기기변경","개통","단말","MNP"         → 기기변경/개통 화면
"요금제","요금","청구","과금","납부"    → 요금제 변경 화면
"데이터","부가서비스","리필","속도"     → 데이터/부가서비스 화면
```

- **First-match 우선순위**: 구체적 주제(로밍, 분실)가 범용 주제(데이터)보다 먼저 매칭
- **폴백**: 매칭 없을 시 데이터/부가서비스 화면 (가장 범용)

---

## 기술 스택

| 레이어 | 기술 |
|---|---|
| 프론트엔드 | Next.js 16, React, TypeScript, Tailwind CSS |
| 음성 처리 | Web Audio API, AudioWorklet, WebSocket |
| AI/NLP | OpenAI Realtime API (STT), GPT-4o-mini (키워드), text-embedding-3-small (벡터) |
| 데이터베이스 | Supabase PostgreSQL + pgvector |
| 배포 | Next.js App Router (서버/클라이언트 하이브리드) |

---

## 데이터 플로우 타임라인

```
0ms     고객 발화 시작
        ├─ AudioWorklet: 실시간 리샘플링 + WebSocket 전송
        ├─ Realtime API: delta 텍스트 스트리밍 (실시간 자막)
        │
~1-3s   고객 발화 종료 (VAD 감지)
        ├─ completed 이벤트: 전체 텍스트 수신
        │
~1-3s   검색 API 호출 (병렬)
+0ms    ├─ GPT-4o-mini: 키워드 추출
+0ms    └─ text-embedding-3-small: 벡터 생성
        │
~0.5-1s 결과 반환
        ├─ ContentViewer: 매뉴얼 페이지 표시
        ├─ CrmDemoPanel: CRM 업무 화면 전환
        └─ 첫 번째 결과 자동 선택
        │
총 소요  약 2-5초 (발화 종료 후)
```

---

## 화면 구성

```
┌──────────────────┬──────────────────────────────────┐
│  좌측 (380px)     │  우측 (나머지 전체)                │
│                   │                                   │
│  실시간 자막       │  매뉴얼 뷰어 (55%)                │
│  PDF 업로드       │  - 검색된 매뉴얼 페이지 표시       │
│  문서 목록        │  - 유사도 점수                     │
│  검색 입력        ├──────────────────────────────────┤
│  검색 결과 목록    │  CRM 데모 화면 (45%)              │
│                   │  - 고객정보 헤더                   │
│                   │  - 키워드 기반 업무 화면            │
│                   │  - 6개 화면 타입 자동 전환          │
└──────────────────┴──────────────────────────────────┘
```
